<!DOCTYPE html>
<html lang="zh">
	<head>
		<link href="http://gmpg.org/xfn/11" rel="profile">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="content-type" content="text/html; charset=utf-8">

		<!-- Enable responsiveness on mobile devices-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

		<title>Tech Rain</title>

		<!-- CSS -->
		<link href="//fonts.googleapis.com/" rel="dns-prefetch">
		<link href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Abril+Fatface|PT+Sans:400,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet">

		<link rel="stylesheet" href="https://blog.inndy.tw/theme/css/poole.css" />
		<link rel="stylesheet" href="https://blog.inndy.tw/theme/css/hyde.css" />
		<link rel="stylesheet" href="https://blog.inndy.tw/theme/css/syntax.css" />
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

		<!-- RSS -->
		<link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
	</head>

	<body class="theme-base-0d">
<div class="sidebar">
	<div class="container sidebar-sticky">
		<div class="sidebar-about">

			<h1>
				<a href="/">
					<img class="profile-picture" src="https://gravatar.com/avatar/26cdb92aafb2b2e6c8972edebda4bd17?s=360">
					Tech Rain
				</a>
			</h1>
                <h4>技術需要雨水滋潤才能成長茁壯</h4>
			<p class="lead"></p>
			<p class="lead">It's Inndy speaking. </p>
			<p></p>
		</div>
		<nav class="sidebar-nav">
					<a class="sidebar-nav-item" href="https://github.com/Inndy">
						<i class="fa fa-github"></i>
					</a>
					<a class="sidebar-nav-item" href="https://twitter.com/Inndy_tw">
						<i class="fa fa-twitter"></i>
					</a>
			<a class="sidebar-nav-item" href="">
				<i class="fa fa-feed"></i>
			</a>
		</nav>
	</div>
</div>		<div class="content container">
<div class="post">
	<h1 class="post-title">APK逆向經驗：取回正點工具箱程式鎖密碼</h1>
	<span class="post-date">2014/02/02 07:12</span>
	<h3>過程中使用到的工具：</h3>
<ul>
<li>Python<ul>
<li>因為我要從幾百個檔案中，找出其中一個包含有指定字串的檔案...<a href="http://python.org/">http://python.org/</a> </li>
</ul>
</li>
<li>~~這樣真的很蠢，請愛用 <code>find</code> <code>grep</code>~~ (thanks to Orange)</li>
<li>onekey-decompile-apk<ul>
<li>APK拖進去就給你Java Code<a href="http://code.google.com/p/onekey-decompile-apk/">http://code.google.com/p/onekey-decompile-apk/</a> </li>
</ul>
</li>
<li>APK multi-tool<ul>
<li>我用的是 apk.tw 上，繁體中文化的版本這東西可以解出smali和resource，而且可以打包回APK <a href="https://github.com/APK-Multi-Tool/APK-Multi-Tool">https://github.com/APK-Multi-Tool/APK-Multi-Tool</a> <a href="http://apk.tw/thread-217838-1-1.html">http://apk.tw/thread-217838-1-1.html</a> </li>
</ul>
</li>
<li>Notepad++<ul>
<li>Windows下超讚的文字編輯器，因為APK multi-tool linux版好像怪怪的，只好用Windows <a href="http://notepad-plus-plus.org/">http://notepad-plus-plus.org/</a> </li>
</ul>
</li>
<li>一支 Root 過的手機<ul>
<li>其實可以用模擬器替代啦... </li>
<li><a href="http://api.sonymobile.com/files/xperia-sl-hero-black-1240x840-846460e0dc616cc64025fc40df13a6db.jpg"><img alt="" src="http://api.sonymobile.com/files/xperia-sl-hero-black-1240x840-846460e0dc616cc64025fc40df13a6db.jpg" /></a></li>
</ul>
</li>
<li>adb<ul>
<li><a href="http://developer.android.com/tools/help/adb.html">http://developer.android.com/tools/help/adb.html</a> </li>
</ul>
</li>
</ul>
<!--more-->

<h3>第一步：把apk抓出來</h3>
<div class="highlight"><pre><span></span>  Microsoft Windows [版本 6.1.7601]  
  Copyright (c) 2009 Microsoft Corporation. All rights reserved.  

  C:\Users\Inndy&gt;adb shell  
  shell@android:/ $ su  
  su  
  root@android:/ # cd data/app  
  cd data/app  
  root@android:/data/app # ls | busybox grep -e &#39;zd&#39;  
  ls | busybox grep -e &#39;zd&#39;  
  com.zdworks.android.toolbox-1.apk  
  root@android:/data/app # exit  
  exit  
  shell@android:/ $ exit  
  exit  

  C:\Users\Inndy&gt;adb pull /data/app/com.zdworks.android.toolbox-1.apk  
  2875 KB/s (6326169 bytes in 2.148s)  

  C:\Users\Inndy&gt;
</pre></div>


<h3>第二步：分別丟進兩種工具反編譯</h3>
<h3>第三步：找出關鍵字串和參考點</h3>
<p>從 APK multi-tool 解出來的東西裡面找，String Resource在 res\values-zh-rTW\strings.xml 裡面，搜尋 "密碼錯誤" 後找到...  </p>
<p><code>Line 309: &lt;string name="input_fail"&gt;密碼錯誤請重新輸入!&lt;/string&gt;"</code><br />
然後我寫了一個Python Script去找含有 "input_fail" 的檔案，藉此挖出Resource ID  </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s2">&quot;./smali&quot;</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input_fail&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input_fail&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Line </span><span class="si">%5d</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">=== Result ===</span>

<span class="sd">C:\Users\Inndy\Desktop\APK Multi-Tool V1.0.11\projects\zdbox.apk\smali\com\zdworks\android\toolbox\R$string.smali</span>
<span class="sd">Line  1966:.field public static final input_fail:I = 0x7f090342</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>


<p>接著在onekey-decompile-apk解出來的source裡面尋找檔名：applock<br />
會找到很多檔案，全部丟進Notepad++打開<br />
搜索所有檔案 -&gt; "2131297090"  (2131297090 = 0x7f090342)<br />
接著找到了...  </p>
<div class="highlight"><pre><span></span>  <span class="nt">C</span><span class="o">:</span><span class="err">\</span><span class="nt">Users</span><span class="err">\</span><span class="nt">Inndy</span><span class="err">\</span><span class="nt">Desktop</span><span class="err">\</span><span class="nt">zdbox</span><span class="nc">.apk.src</span><span class="err">\</span><span class="nt">com</span><span class="err">\</span><span class="nt">zdworks</span><span class="err">\</span><span class="nt">android</span><span class="err">\</span><span class="nt">toolbox</span><span class="err">\</span><span class="nt">ui</span><span class="err">\</span><span class="nt">applock</span><span class="err">\</span><span class="nt">AppLockPasswordActivity</span><span class="nc">.java</span> <span class="o">(</span><span class="nt">1</span> <span class="nt">hit</span><span class="o">)</span>
 <span class="nt">Line</span> <span class="nt">109</span><span class="o">:</span>       <span class="nt">Toast</span><span class="nc">.makeText</span><span class="o">(</span><span class="nt">this</span><span class="o">,</span> <span class="nt">getString</span><span class="o">(</span><span class="nt">2131297090</span><span class="o">),</span> <span class="nt">0</span><span class="o">)</span><span class="nc">.show</span><span class="o">();</span>
  <span class="nt">C</span><span class="o">:</span><span class="err">\</span><span class="nt">Users</span><span class="err">\</span><span class="nt">Inndy</span><span class="err">\</span><span class="nt">Desktop</span><span class="err">\</span><span class="nt">zdbox</span><span class="nc">.apk.src</span><span class="err">\</span><span class="nt">com</span><span class="err">\</span><span class="nt">zdworks</span><span class="err">\</span><span class="nt">android</span><span class="err">\</span><span class="nt">toolbox</span><span class="err">\</span><span class="nt">ui</span><span class="err">\</span><span class="nt">applock</span><span class="err">\</span><span class="nt">ApplockPatternActivity</span><span class="nc">.java</span> <span class="o">(</span><span class="nt">1</span> <span class="nt">hit</span><span class="o">)</span>
 <span class="nt">Line</span> <span class="nt">348</span><span class="o">:</span>           <span class="nt">Toast</span><span class="nc">.makeText</span><span class="o">(</span><span class="nt">ApplockPatternActivity</span><span class="nc">.this</span><span class="o">,</span> <span class="nt">2131297090</span><span class="o">,</span> <span class="nt">0</span><span class="o">)</span><span class="nc">.show</span><span class="o">();</span>
</pre></div>


<p>接下來就是Code Review找來源  </p>
<div class="highlight"><pre><span></span><span class="c1">// com\zdworks\android\toolbox\ui\applock\AppLockPasswordActivity.java</span>
<span class="c1">// Line 340 </span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPatternDetected</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">LockPatternView</span><span class="o">.</span><span class="na">Cell</span><span class="o">&gt;</span> <span class="n">paramList</span><span class="o">)</span>
<span class="o">{</span>
  <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">PasswordUtils</span><span class="o">.</span><span class="na">patternToString</span><span class="o">(</span><span class="n">paramList</span><span class="o">);</span>
  <span class="n">ApplockPatternActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">mHandler</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="k">new</span> <span class="n">ApplockPatternActivity</span><span class="o">.</span><span class="na">AutoClearThread</span><span class="o">(</span><span class="n">ApplockPatternActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="kc">null</span><span class="o">),</span> <span class="mi">1000L</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">crtPattern</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">str</span><span class="o">))</span>
 <span class="k">if</span> <span class="o">((!</span><span class="n">ApplockPatternActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">checkpattern</span><span class="o">(</span><span class="n">str</span><span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">ApplockPatternActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">calledIntent</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">ApplockPatternActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">calledIntent</span> <span class="o">!=</span> <span class="mi">4</span><span class="o">))</span>
 <span class="o">{</span>
   <span class="n">ApplockPatternActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">setPatternState</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
   <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">ApplockPatternActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="mi">2131297090</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
   <span class="n">ApplockPatternActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">initTitle</span><span class="o">();</span>
 <span class="o">}</span>
  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span>
  <span class="o">{</span>
 <span class="k">return</span><span class="o">;</span>
 <span class="n">ApplockPatternActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">setPatternState</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
 <span class="n">ApplockPatternActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">finishInputPassword</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
 <span class="k">continue</span><span class="o">;</span>
 <span class="k">this</span><span class="o">.</span><span class="na">crtPattern</span> <span class="o">=</span> <span class="n">str</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">// com\zdworks\android\toolbox\ui\applock\ApplockPatternActivity.java</span>
<span class="c1">// Line 199 </span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkpattern</span><span class="o">(</span><span class="n">String</span> <span class="n">paramString</span><span class="o">)</span>
<span class="o">{</span>
  <span class="k">return</span> <span class="n">paramString</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">patternPassword</span><span class="o">);</span>
<span class="o">}</span>


<span class="c1">// Line 181</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">initView</span><span class="o">()</span>
<span class="o">{</span>
  <span class="n">initRecommendZDLockView</span><span class="o">();</span>
  <span class="k">this</span><span class="o">.</span><span class="na">patternPassword</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mConfig</span><span class="o">.</span><span class="na">getApplockPasswordPattern</span><span class="o">();</span>
  <span class="k">this</span><span class="o">.</span><span class="na">mLockView</span> <span class="o">=</span> <span class="o">((</span><span class="n">LockPatternView</span><span class="o">)</span><span class="n">findViewById</span><span class="o">(</span><span class="mi">2131427460</span><span class="o">));</span>
  <span class="k">this</span><span class="o">.</span><span class="na">mForgetPassword</span> <span class="o">=</span> <span class="o">((</span><span class="n">LinearLayout</span><span class="o">)</span><span class="n">findViewById</span><span class="o">(</span><span class="mi">2131427459</span><span class="o">));</span>
  <span class="k">this</span><span class="o">.</span><span class="na">mLockView</span><span class="o">.</span><span class="na">setOnPatternListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ApplockPatternListener</span><span class="o">(</span><span class="kc">null</span><span class="o">));</span>
  <span class="k">if</span> <span class="o">((-</span><span class="mi">1</span> <span class="o">!=</span> <span class="k">this</span><span class="o">.</span><span class="na">mConfig</span><span class="o">.</span><span class="na">getSecurityQuestionIndex</span><span class="o">())</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">calledIntent</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">calledIntent</span> <span class="o">!=</span> <span class="mi">4</span><span class="o">))</span>
  <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mForgetPassword</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">((</span><span class="n">TextView</span><span class="o">)</span><span class="n">findViewById</span><span class="o">(</span><span class="mi">2131427799</span><span class="o">)).</span><span class="na">getPaint</span><span class="o">().</span><span class="na">setFlags</span><span class="o">(</span><span class="mi">9</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mForgetPassword</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">this</span><span class="o">.</span><span class="na">mLockView</span><span class="o">.</span><span class="na">enableInput</span><span class="o">();</span>
  <span class="k">this</span><span class="o">.</span><span class="na">mLockView</span><span class="o">.</span><span class="na">setInStealthMode</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mConfig</span><span class="o">.</span><span class="na">isHideTrace</span><span class="o">());</span>
  <span class="k">this</span><span class="o">.</span><span class="na">mLockView</span><span class="o">.</span><span class="na">setInVibrateMode</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mConfig</span><span class="o">.</span><span class="na">isVibrateTracelessUnlock</span><span class="o">());</span>
<span class="o">}</span>


<span class="c1">// Line 54</span>
<span class="kd">private</span> <span class="n">ConfigManager</span> <span class="n">mConfigManager</span><span class="o">;</span> 
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">// com\zdworks\android\toolbox\global\ConfigManager.java</span>
<span class="c1">// Line 377</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">getApplockPasswordPattern</span><span class="o">()</span>
<span class="o">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">mSharedPre</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;applock_pw_pattern&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
<span class="o">}</span>


<span class="c1">// Line 219</span>
<span class="kd">private</span> <span class="nf">ConfigManager</span><span class="o">(</span><span class="n">Context</span> <span class="n">paramContext</span><span class="o">)</span>
<span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">mContext</span> <span class="o">=</span> <span class="n">paramContext</span><span class="o">;</span>
  <span class="k">this</span><span class="o">.</span><span class="na">mSharedPre</span> <span class="o">=</span> <span class="n">PreferenceManager</span><span class="o">.</span><span class="na">getDefaultSharedPreferences</span><span class="o">(</span><span class="n">paramContext</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p>跟到最上面發現原來是<a href="http://developer.android.com/reference/android/preference/PreferenceManager.html">PreferenceManager</a>，可以去把我的密碼找出來了！  </p>
<div class="highlight"><pre><span></span>Microsoft Windows [版本 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\Inndy&gt;adb shell
shell@android:/ $ su
su
root@android:/ # cd data/data
cd data/data
root@android:/data/data # ls | busybox grep -e &#39;zd&#39;
ls | busybox grep -e &#39;zd&#39;
com.zdworks.android.toolbox
root@android:/data/data # cd com.zd*
cd com.zd*
root@android:/data/data/com.zdworks.android.toolbox # ls
ls
cache
databases
files
lib
shared_prefs
root@android:/data/data/com.zdworks.android.toolbox # cd sh*
cd sh*
root@android:/data/data/com.zdworks.android.toolbox/shared_prefs # ls
ls
GetJarClientPrefs.xml
com.zdworks.android.toolbox_preferences.xml
com.zdworks.android.toolboxsession.xml
lastUsageCheckFile.xml
splash_hash.xml
splash_pref.xml
timestamp.xml
zda_agent_online_setting_com.zdworks.android.toolbox.xml
root@android:/data/data/com.zdworks.android.toolbox/shared_prefs # cat com.zdwor
ks.android.toolbox_preferences.xml | busybox grep -e &#39;applock_pw_pattern&#39;
&lt;string name=&quot;applock_pw_pattern&quot;&gt;*******&lt;/string&gt;
root@android:/data/data/com.zdworks.android.toolbox/shared_prefs #
</pre></div>


<p>搞定了，結案。  </p>
<p><strong>最後小提醒：保護手機安全，請隨手關閉adb，並且把adb shell的 root 權限設定為每次詢問。</strong></p>
</div>
		</div>
	</body>
</html>